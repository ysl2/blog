# [\#7 Issue](https://github.com/ysl2/blog/issues/7) `open`: 内网穿透

#### <img src="https://avatars.githubusercontent.com/u/39717545?u=3a56d7b47e1688f70c83e440ba0835f8d24c43e3&v=4" width="50">[ysl2](https://github.com/ysl2) opened issue at [2024-01-28 15:37](https://github.com/ysl2/blog/issues/7):

### Frp

#### 自建

按照官网的教程来

https://gofrp.org/docs/examples/ssh/

注意公网服务器上面需要开放相应的端口

sdu_net 一旦检测到有 frp 行为，会直接封禁 ip。因此如果要用的话，需要做 tls 加密。而且就算采用了加密，也不知道能不能行，因为没法测试了，我的腾讯云的 ip 已经被封了。

可以采用外部 frp 嵌套内部 autossh 的方法。对于封禁 ip 的网段，采用 autossh 先连接到其他不封禁的网段。然后把不封禁的这台机器的对应端口用 frp 映射出去。比如 yin3 在 2244 端口用 autossh 映射了 server-53 的 22 端口，然后再找个公网机器用 frp 映射 yin3 的 2244 端口。这样在外部访问 frp 端口，就直接映射到了 server-53 的 22 端口，并且 server-53 对应的网段还检测不到。

#### 樱花frp

```
# which sfrpc
# ~/.Local/bin/my/sfrp/sfrpc
# ln -s ~/.Local/bin/my/sfrp/sfrpc ~/.Local/bin/sfrpc
sfrpc -c ~/.Local/bin/my/sfrp/sfrpc.ini --natfrp_tls
```

## Autossh

1. 准备

   内网机器 A

   - ip: 172.27.67.80
   - ssh port: 22
   - username: yusongli
   - passwd: ysl123

   公网机器 B

   - ip: 47.105.198.227
   - ssh port: 22
   - username: gongwang
   - passwd: gw1234

1. 在公网主机 B 上配置`/etc/ssh/sshd_config`文件，改以下字段为`yes`，然后重启 ssh 服务

   ```bash
   # 意思是监听端口可以绑定到任意其他ip
   GatewayPorts yes

   sudo systemctl restart sshd
   ```

1. 在内网主机 A 上生成 ssh key，并对 B 做免密登录

   ```bash
   ssh-keygen
   ssh-copy-id gongwang@47.105.198.227
   ```

1. 在内网主机 A 上做端口映射(需要安装`autossh`)

   ```bash
   # autossh -M {本地主机端口} -NfR {公网主机端口}:localhost:22 {公网主机用户}@{公网ip}
   autossh -M 10550 -NfR 9550:localhost:22 gongwang@47.105.198.227
   ```

1. 端口占用情况

   - A 仅有 10550 端口会被占用 (可能是因为学校屏蔽公网下内网穿透的原因。以前的时候好像A也是9550和10550都会被占用)
   - B 的 9550 端口和 10550 端口都会被占用
   - 9550 是用来在公网主机上登录的端口

1. 开机自启

   ```bash
   sudo vim /etc/rc.local

   # 加入上面那行代码
   autossh -M 10550 -NfR 9550:localhost:22 gongwang@47.105.198.227
   ```

1. kill

   1. 方式一

      应该先在内网主机A上，通过`ps aux | grep autossh`找到autossh所在的PID，kill掉。

      此时公网主机B上的9550和10550端口会自动断开。

      然后再在内网主机A上通过`lsof -i:9550`或者`lsof -i:10550`找到对应PID，然后kill掉。

   1. 方式二 (可能不好用，并且可能只适用于学校屏蔽公网下内网穿透的情况)

      在任意A或者B上，通过`lsof -i:9550`或者`lsof -i:10550`找到对应PID，然后kill掉。

      此时另一个主机会自动断开。




-------------------------------------------------------------------------------



[Export of Github issue for [ysl2/blog](https://github.com/ysl2/blog). Generated on 2025.07.03 at 11:43:05.]
