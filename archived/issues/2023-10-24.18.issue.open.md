# [\#18 Issue](https://github.com/ysl2/.dotfiles/issues/18) `open`: 关于~/.profile和[login shell/non-login shell]的问题

#### <img src="https://avatars.githubusercontent.com/u/39717545?u=3a56d7b47e1688f70c83e440ba0835f8d24c43e3&v=4" width="50">[ysl2](https://github.com/ysl2) opened issue at [2023-10-24 13:27](https://github.com/ysl2/.dotfiles/issues/18):

Ref:

Difference between `login shell` and `non-login shell`.

https://linux.vbird.org/linux_basic/centos7/0320bash.php#settings_bashrc

<!-- Deepin doesn't read `~/.profile` when non-login with lightdm. It only read `/etc/profile` -->

<!-- Picture below from: https://bbs.deepin.org/en/post/217599 -->

<!-- ![image](https://github.com/ysl2/.dotlib/assets/39717545/3e67f32b-9e4e-4708-ba48-deaed153053c) -->

<!-- Solution for deepin: -->

<!-- ```bash -->
<!-- # /etc/X11/Xsession.d/01deepin-profile -->

<!-- [[ -f /etc/profile ]] && . /etc/profile -->
<!-- ``` -->

<!-- Picture below from: https://bbs.deepin.org/en/post/202021 -->

<!-- ![image](https://github.com/ysl2/.dotlib/assets/39717545/0162d54c-d7db-46e7-af9f-9ae5318d15be) -->



#### <img src="https://avatars.githubusercontent.com/u/39717545?u=3a56d7b47e1688f70c83e440ba0835f8d24c43e3&v=4" width="50">[ysl2](https://github.com/ysl2) commented at [2023-10-24 15:10](https://github.com/ysl2/.dotfiles/issues/18#issuecomment-1777448278):

```
-rw-------  1 yusongli yusongli   5826 Oct 24 22:49 .bash_history
-rw-r--r--  1 yusongli yusongli    220 Aug  4  2020 .bash_logout
lrwxrwxrwx  1 yusongli yusongli     15 Aug  7 13:33 .bashrc -> .dotlib/.bashrc
-rw-r--r--  1 yusongli yusongli   1203 Oct 24 23:00 .bashrc.localhost.post
lrwxrwxrwx  1 yusongli yusongli     16 Oct 24 18:59 .profile -> .dotlib/.profile
-rw-r--r--  1 yusongli yusongli     19 Oct 24 22:59 .profile.localhost
```

localhost文件被相应的主文件调用。每个文件的最后一行是写入log。

首先采用常规lightdm登录deepin-de，然后直接用文件浏览器看log

![image](https://github.com/ysl2/.dotlib/assets/39717545/cd4d009a-3bf3-4648-9f7c-d66b4b29b93b)

然后再打开alacritty进入bash，再次看log

![image](https://github.com/ysl2/.dotlib/assets/39717545/4f0530c0-6656-4687-a779-9862d0f9b820)

`sudo systemctl disable lightdm`，采用自动`exec startx`的方式登录dwm，然后什么都不做直接关机，用livecd看log

![image](https://github.com/ysl2/.dotlib/assets/39717545/b694d789-2ebf-4b66-bdf1-e4f794644860)

然后删掉log，重新登录dwm，用alacritty打开bash，查看log

![image](https://github.com/ysl2/.dotlib/assets/39717545/872ac917-7f9e-427c-9920-3e7ca7b4fec9)

#### <img src="https://avatars.githubusercontent.com/u/39717545?u=3a56d7b47e1688f70c83e440ba0835f8d24c43e3&v=4" width="50">[ysl2](https://github.com/ysl2) commented at [2023-10-24 16:00](https://github.com/ysl2/.dotfiles/issues/18#issuecomment-1777549921):

补充实验：

dwm登录后打开bash (auto startx)

![image](https://github.com/ysl2/.dotlib/assets/39717545/880336b8-7343-4ba5-963d-1aaa11c35dd6)

然后关了bash再开一次

![image](https://github.com/ysl2/.dotlib/assets/39717545/bab58ad1-a7a3-41fb-b262-d1a2281ba64c)

用lightdm登录deepin-de，直接用文件管理器看log (注意此时忘记清上面的log，因此log的前几行是上次的内容)

![image](https://github.com/ysl2/.dotlib/assets/39717545/8e9c6364-d5ae-4905-a32f-abf3ea0db567)

然后打开bash

![image](https://github.com/ysl2/.dotlib/assets/39717545/1257c97d-3f40-4178-bda1-bbbb004479bd)

#### <img src="https://avatars.githubusercontent.com/u/39717545?u=3a56d7b47e1688f70c83e440ba0835f8d24c43e3&v=4" width="50">[ysl2](https://github.com/ysl2) commented at [2023-10-24 16:36](https://github.com/ysl2/.dotfiles/issues/18#issuecomment-1777613623):

![image](https://github.com/ysl2/.dotlib/assets/39717545/61885876-101f-4c18-a300-c117b3d84fb8)

#### <img src="https://avatars.githubusercontent.com/u/39717545?u=3a56d7b47e1688f70c83e440ba0835f8d24c43e3&v=4" width="50">[ysl2](https://github.com/ysl2) commented at [2023-10-24 16:43](https://github.com/ysl2/.dotfiles/issues/18#issuecomment-1777625627):

总结：

对于deepin使用lightdm登录无论是deepin-de还是dwm，都会加载`~/.profile`。

使用exec startx登录，也会加载`~/.profile`。

关键在于，startx一旦exec，整个文件后面的所有内容全都检测不到。

另外，在登录的时候，会加载`/etc/profile`和`~/.profile`，不会主动加载`~/.bashrc`除非在`~/.profile`中强制触发它。

在登录完成之后，如果再打开新的bash，此时只会加载`~/.bashrc`，不会加载`/etc/profile`和`~/.profile`。

#### <img src="https://avatars.githubusercontent.com/u/39717545?u=3a56d7b47e1688f70c83e440ba0835f8d24c43e3&v=4" width="50">[ysl2](https://github.com/ysl2) commented at [2023-10-24 16:49](https://github.com/ysl2/.dotfiles/issues/18#issuecomment-1777639780):

但是注意，关于键盘改建，如果想一登录就自动改键位：

首先，对于exec startx方式，如果放在`~/.profile`的startx之前改键，会提示不在x11中，报错。如果放在`~/.profle`的startx之后，此时因为exec又检测不到。说明这种方式无法实现，需要依赖其他方法比如dwm的autorun补丁，在进入dwm之后再运行改键脚本。

其次，对于lightdm方式，`~/.profile`是被从头到尾加载一遍的。之前的改键失效可能是由于没有使用正确的语法，导致未加载`~/.profile.localhost`。

#### <img src="https://avatars.githubusercontent.com/u/39717545?u=3a56d7b47e1688f70c83e440ba0835f8d24c43e3&v=4" width="50">[ysl2](https://github.com/ysl2) commented at [2023-10-24 17:11](https://github.com/ysl2/.dotfiles/issues/18#issuecomment-1777674178):

一个细节，在`~/.profile`中，关于bashrc的强制加载，是仅限于当打开bash的时候，因为它会检测`$BASH_VERSION`变量。

因此，

对于lightdm找不到自定义的$PATH，是因为lightdm直接跳过了bash，也就没加载bashrc直接进的系统。

对于exec startx如果把加载bashrc放在它的前面能找到，是因为通过exec startx实际上也是先进入的bash (此时有`$BASH_VERSION`变量)，再exec startx。就从密码正确进入bash，到exec之前，这个短暂的时间差，就已经加载到了bashrc。

#### <img src="https://avatars.githubusercontent.com/u/39717545?u=3a56d7b47e1688f70c83e440ba0835f8d24c43e3&v=4" width="50">[ysl2](https://github.com/ysl2) commented at [2023-10-24 17:14](https://github.com/ysl2/.dotfiles/issues/18#issuecomment-1777678426):

初步解决方案（需进一步查明正确性）：

`exec startx`应该放在`~/.profile`的末尾。

改键的脚本不应该在`~/.profile`中出现，而是在桌面环境进入之后再执行。比如dwm的autorun补丁，进入dwm之后执行改键。或者是放在deepin-de的`~/.config/autostart`，进入桌面之后自启动改键。

自定义的PATH应该优先往`~/.profile`里面放，但也要考虑non-login shell是否每次都能加载到。

考虑自动加载tmux的是不是也应该优先往`~/.profile`里面放。

#### <img src="https://avatars.githubusercontent.com/u/39717545?u=3a56d7b47e1688f70c83e440ba0835f8d24c43e3&v=4" width="50">[ysl2](https://github.com/ysl2) commented at [2023-10-25 04:13](https://github.com/ysl2/.dotfiles/issues/18#issuecomment-1778477260):

tmux每打开一个pane，都是只加载`~/.profile`，然后通过`~/.profile`去加载`~/.bashrc`

#### <img src="https://avatars.githubusercontent.com/u/39717545?u=3a56d7b47e1688f70c83e440ba0835f8d24c43e3&v=4" width="50">[ysl2](https://github.com/ysl2) commented at [2023-10-25 09:16](https://github.com/ysl2/.dotfiles/issues/18#issuecomment-1778849189):

下面这个图有错误，但是意思大体是这样的
```
                  │                                                                       │
                  │                                                                       │
                  │                                        ┌──────────┐                   │
                  │                                        │~/.profile│                   │
                  │                                        └────┬─────┘                   │
                  │                                             │                         │
                  │                         ┌───────────────────┴───────────────────┐     │
                  │         2.              ▼                                       ▼     │
                  │       ┌──────┐     ┌──────────┐                              ┌──────┐ │
                  │       │startx│     │~/.bashrc │                           1. │startx│ │
                  │       └──────┘     └────┬─────┘                              └──────┘ │
                  │           │             │                                             │
                  │    ┌──────┼───────┬─────┴─────┬───────────────┐                       │
                  │    │      │       │           │               │                       │
                  │    ▼      ▼       ▼           ▼               ▼                       │
                  │ ┌───┐ (check   ┌────┐       ┌─────┐       ┌──────┐                    │
                  │ │ENV│  return) │TMUX│       │conda│       │others│                    │
                  │ └───┘          └────┘       └─────┘       └──────┘                    │
──────────────────┼───────────────────────────────────────────────────────────────────────┼────────────────────────────────────────────────────►
      lightdm     │   Y  $- != *i*   -             -             -                  -     │ ~/.profile + ~/.bashrc
      startx      │   Y  -z "$DISP"  -             -             -                  Y     │ ~/.profile + ~/.bashrc
      bash tmux   │   Y  checktmux   Y             -             Y                  -     │ ~/.profile + ~/.bashrc
      bash tm co  │   Y  checktmux   Y  checkconda Y             Y                  -     │ ~/.profile + ~/.bashrc
      bash conda  │   Y              -  checkconda Y             Y                  -     │ ~/.bashrc
      bash pure   │   Y              -             -             Y                  -     │ ~/.bashrc
                  │                                                                       │
                  │                                                                       │
                  │                                                                       │
                  │                                                                       │
                  │                                                                       │
                  │                                                                       │
                  │                                                                       │
                  │                                                                       │
                  │                                                                       │
                  │                                                                       │
                  │                                                                       │
                  │                                                                       │
                  │                                                                       │
                  │                                                                       │
                  │                                                                       │
                  │                                                                       │
                  ▼                                                                       ▼

```

#### <img src="https://avatars.githubusercontent.com/u/39717545?u=3a56d7b47e1688f70c83e440ba0835f8d24c43e3&v=4" width="50">[ysl2](https://github.com/ysl2) commented at [2025-02-23 13:26](https://github.com/ysl2/.dotfiles/issues/18#issuecomment-2676862279):

MacOS下一点新的思考，可能也适用linux。

`~/.profile`链接到`~/.bashrc`，只是为了特定在linux下登录的时候，加载环境变量部分用的（linux下登录过程会走DM，或者禁用DM走startx的时候也会有shell的source过程，这两种都会走`~/.profile`）。加载完环境变量部分之后，我就会通过`~/.bashrc`里面的条件设置，让登录时的加载环境变量过程退出，从而继续加载其他登录设置。否则会继续执行`~/.bashrc`导致登录过程加载失败。

所以MacOS下，没必要把`~/.profile`链接到`~/.bashrc`，因为就算链接到也不会加载。因为MacOS登录过程不经过`~/.profile`。

对于`~/.zprofile`，没有必要链接到`~/.bashrc`，因为linux和MacOS登录的时候并不加载`~/.zprofile`。并且zsh每次打开的时候都会先加载`~/.zprofile`，如果链接到`~/.bashrc`会导致每次都加载两遍`~/.bashrc`。

此外，tmux下是否每打开一个pane都加载`~/.profile`，这件事需要评估。有可能跟使用的shell也有关系。我在MacOS下使用的默认shell是zsh。当我打开tmux的时候，并不自动加载`~/.profile`。linux需要进一步评估是不是跟bash有关，尤其是在ssh服务器的时候的表现。

对于MacOS下neovide，需要通过`~/.zprofile`或者`~/.zshenv`指定nvim变量位置。考虑`~/.zprofile影响较大`，我把$(which nvim)所在的上级文件夹加在了`~/.zshenv`里面，而不是`~/.zprofile`。目前遗留的问题是，不知道linux是否需要做同样的设置。待后续验证。

#### <img src="https://avatars.githubusercontent.com/u/39717545?u=3a56d7b47e1688f70c83e440ba0835f8d24c43e3&v=4" width="50">[ysl2](https://github.com/ysl2) commented at [2025-03-02 01:56](https://github.com/ysl2/.dotfiles/issues/18#issuecomment-2692511210):

结论：ssh服务器的时候，优先会去找~/.bash_profile，如果这个文件有，就只会加载这个。如果没有，会再去找~/.profile。然后整个流程就结束了。至于加载~/.bashrc，是因为在~/.bash_profile或者是~/.profile里面有指定。

解决方案：对于ssh服务器的场景，把~/.profile连接到~/.bashrc，让~/.profile作为rc进行加载。

https://github.com/user-attachments/assets/dca9def0-db2a-45ed-bde2-e6d66030ea7a

#### <img src="https://avatars.githubusercontent.com/u/39717545?u=3a56d7b47e1688f70c83e440ba0835f8d24c43e3&v=4" width="50">[ysl2](https://github.com/ysl2) commented at [2025-03-02 02:22](https://github.com/ysl2/.dotfiles/issues/18#issuecomment-2692519696):

结论：mac下启动终端，会先执行两次~/.zshenv，然后是~/.zprofile，然后是~/.zshrc。打开tmux的时候，也是执行上面这套流程。

补充：mac图形界面启动，不会加载任何文件。

解决方案：对于mac启动终端的场景，不要创建~/.profile和~/.zprofile，（尤其是不要链接~/.zshrc），而是直接创建~/.zshrc，从而避免多次加载。但是对于一些app，比如neovide，对环境变量有要求，但此时加载不到~/.zshrc。这时候需要把环境变量写在~/.zprofile里面。

https://github.com/user-attachments/assets/d4add3d5-d461-4450-a79b-6b1e58fb3bba

#### <img src="https://avatars.githubusercontent.com/u/39717545?u=3a56d7b47e1688f70c83e440ba0835f8d24c43e3&v=4" width="50">[ysl2](https://github.com/ysl2) commented at [2025-03-02 04:43](https://github.com/ysl2/.dotfiles/issues/18#issuecomment-2692555175):

https://github.com/user-attachments/assets/8929fd6e-310f-47c6-a06b-c97a80ff958c

#### <img src="https://avatars.githubusercontent.com/u/39717545?u=3a56d7b47e1688f70c83e440ba0835f8d24c43e3&v=4" width="50">[ysl2](https://github.com/ysl2) commented at [2025-03-02 06:18](https://github.com/ysl2/.dotfiles/issues/18#issuecomment-2692580377):

在 Zsh 中，启动时加载文件的顺序如下：

1. **/etc/zshenv**
   - 系统级别的环境变量配置文件。
   - 所有 Zsh 实例都会首先加载此文件。

2. **~/.zshenv**
   - 用户级别的环境变量配置文件。
   - 每个 Zsh 实例都会加载此文件。

3. **/etc/zprofile**
   - 系统级别的登录 shell 配置文件。
   - 仅当 Zsh 作为登录 shell 时加载。

4. **~/.zprofile**
   - 用户级别的登录 shell 配置文件。
   - 仅当 Zsh 作为登录 shell 时加载。

5. **/etc/zshrc**
   - 系统级别的交互式 shell 配置文件。
   - 仅当 Zsh 作为交互式 shell 时加载。

6. **~/.zshrc**
   - 用户级别的交互式 shell 配置文件。
   - 仅当 Zsh 作为交互式 shell 时加载。

7. **/etc/zlogin**
   - 系统级别的登录 shell 配置文件。
   - 仅当 Zsh 作为登录 shell 时加载。

8. **~/.zlogin**
   - 用户级别的登录 shell 配置文件。
   - 仅当 Zsh 作为登录 shell 时加载。

### 退出时加载的文件
1. **~/.zlogout**
   - 用户级别的退出 shell 配置文件。
   - 仅当 Zsh 作为登录 shell 退出时加载。

2. **/etc/zlogout**
   - 系统级别的退出 shell 配置文件。
   - 仅当 Zsh 作为登录 shell 退出时加载。

### 总结
- **所有 Zsh 实例**：`/etc/zshenv` → `~/.zshenv`
- **登录 shell**：`/etc/zprofile` → `~/.zprofile` → `/etc/zshrc` → `~/.zshrc` → `/etc/zlogin` → `~/.zlogin`
- **交互式 shell**：`/etc/zshrc` → `~/.zshrc`
- **退出登录 shell**：`~/.zlogout` → `/etc/zlogout`

#### <img src="https://avatars.githubusercontent.com/u/39717545?u=3a56d7b47e1688f70c83e440ba0835f8d24c43e3&v=4" width="50">[ysl2](https://github.com/ysl2) commented at [2025-03-02 06:19](https://github.com/ysl2/.dotfiles/issues/18#issuecomment-2692580853):

在 Bash 中，加载和 `source` 文件的顺序取决于具体的场景和文件类型。以下是常见情况的加载顺序：

### 1. **交互式登录 Shell**
   - **/etc/profile**: 系统范围的配置文件，首先加载。
   - **~/.bash_profile**, **~/.bash_login**, **~/.profile**: 用户个人配置文件，按顺序加载，找到第一个后停止。
   - **~/.bash_logout**: 用户退出时执行。

### 2. **交互式非登录 Shell**
   - **/etc/bash.bashrc**: 系统范围的配置文件（某些系统）。
   - **~/.bashrc**: 用户个人配置文件，通常在这里设置别名、函数等。

### 3. **非交互式 Shell**
   - 通过 `BASH_ENV` 环境变量指定的文件（如果设置了）。

### 4. **手动 `source` 文件**
   - 使用 `source` 或 `.` 命令加载指定文件，如 `source ~/.myfile` 或 `. ~/.myfile`。

### 5. **脚本执行**
   - 仅执行脚本中的命令，不加载用户配置文件，除非脚本中显式调用 `source` 或 `.`。

### 总结
- **登录 Shell**: `/etc/profile` → `~/.bash_profile`（或 `~/.bash_login`、`~/.profile`）。
- **非登录 Shell**: `/etc/bash.bashrc` → `~/.bashrc`。
- **手动 `source`**: 按命令顺序加载。
- **脚本执行**: 仅执行脚本内容。

#### <img src="https://avatars.githubusercontent.com/u/39717545?u=3a56d7b47e1688f70c83e440ba0835f8d24c43e3&v=4" width="50">[ysl2](https://github.com/ysl2) commented at [2025-03-02 06:32](https://github.com/ysl2/.dotfiles/issues/18#issuecomment-2692584097):

在通过 GDM（GNOME Display Manager）启动时，文件的 `source` 顺序通常遵循以下步骤：

1. **系统级配置文件**：
   - `/etc/profile`：这是系统范围的配置文件，所有用户登录时都会执行。
   - `/etc/profile.d/*.sh`：这个目录下的脚本会在 `/etc/profile` 中被调用，按字母顺序执行。

2. **用户级配置文件**：
   - `~/.bash_profile` 或 `~/.bash_login` 或 `~/.profile`：如果存在这些文件，它们会被依次检查并执行第一个找到的文件。通常用于设置用户环境变量和启动程序。
   - `~/.bashrc`：如果 `~/.bash_profile` 或 `~/.profile` 中调用了 `~/.bashrc`，它也会被执行。通常用于设置交互式 shell 的环境。

3. **GDM 特定配置**：
   - GDM 本身可能会加载一些特定的配置文件，通常位于 `/etc/gdm/` 目录下，例如 `/etc/gdm/Xsession`。这些文件会进一步设置环境变量和启动必要的服务。

4. **Xsession 脚本**：
   - `/etc/X11/Xsession`：这个脚本会在用户会话启动时执行，进一步调用用户级别的 `~/.xsession` 或 `~/.xsessionrc` 文件。

5. **桌面环境启动**：
   - 最后，GDM 会启动用户的桌面环境（如 GNOME），并执行桌面环境的启动脚本和配置文件。

### 总结
文件的 `source` 顺序大致如下：
1. `/etc/profile`
2. `/etc/profile.d/*.sh`
3. `~/.bash_profile` 或 `~/.bash_login` 或 `~/.profile`
4. `~/.bashrc`（如果被调用）
5. GDM 特定配置文件（如 `/etc/gdm/Xsession`）
6. `/etc/X11/Xsession`
7. `~/.xsession` 或 `~/.xsessionrc`
8. 桌面环境启动脚本

#### <img src="https://avatars.githubusercontent.com/u/39717545?u=3a56d7b47e1688f70c83e440ba0835f8d24c43e3&v=4" width="50">[ysl2](https://github.com/ysl2) commented at [2025-03-02 06:36](https://github.com/ysl2/.dotfiles/issues/18#issuecomment-2692585373):

判断是否是登录shell：

```bash
echo $0
```

如果输出是`-zsh`或者`-bash`（前面带`-`），说明是登录shell。如果是`zsh`或者`bash`，说明是非登录shell。

#### <img src="https://avatars.githubusercontent.com/u/39717545?u=3a56d7b47e1688f70c83e440ba0835f8d24c43e3&v=4" width="50">[ysl2](https://github.com/ysl2) commented at [2025-03-02 06:51](https://github.com/ysl2/.dotfiles/issues/18#issuecomment-2692588981):

结论：

对于zsh，只需要一个文件`~/.zshrc`就可以，`~/.zshenv`和`~/.zprofile`有没有不影响，但是neovide的环境变量需要写到`~/.zprofile`里面。

对于bash，需要两个文件`~/.profile`和`~/.bashrc`，同时不能有`~/.bash_profile`和`~/.bash_login`（否则轮不到`~/.profile`加载）。

对于tmux，每打开一个pane都是登录shell，按照上面说的顺序加载。

对于startx，startx本身的过程不走这一套，而是走`~/.xinitrc`那些。但是startx之前，是按照上面这两个顺序加载的。

对于gdm登录i3的时候，是按照上面bash这套流程走的。因此条件和上面这个bash的一样。

gnomerc是给ubuntu用的？

---

因此`~/.profile`链接到`~/.bashrc`用来满足bash的登录shell以及gdm登录，`~/.zshrc`也链接到`~/.bashrc`用来同步zsh和bash的设置。

删掉`~/.bash_profile`和`~/.bash_login`。

在`~/.bashrc`中补充按照当前情况停止source的条件判断，用来满足开机等特殊情况。


-------------------------------------------------------------------------------



[Export of Github issue for [ysl2/.dotfiles](https://github.com/ysl2/.dotfiles). Generated on 2025.06.30 at 17:53:18.]
